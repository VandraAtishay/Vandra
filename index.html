<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vandra â€” KML test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- toGeoJSON (try jsDelivr first; if it fails, fallback to unpkg) -->
  <script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@4.8.0/dist/togeojson.umd.js"></script>
  <script>
    if (!window.toGeoJSON) {
      var s=document.createElement('script');
      s.src='https://unpkg.com/@tmcw/togeojson@4.8.0/dist/togeojson.umd.js';
      document.head.appendChild(s);
    }
  </script>

  <style>
    html,body,#map{height:100%;margin:0}
    .leaflet-container{background:#cfd8dc}
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Base map
    const map = L.map('map', { center:[20,0], zoom:3, worldCopyJump:false });
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors', noWrap:true
    }).addTo(map);

    // Your exact KML URL (capital V in /Vandra/)
    const KML_URL = 'https://vandraatishay.github.io/Vandra/vandra.kml';

    (async () => {
      try {
        // ensure toGeoJSON is there
        await new Promise(resolve => {
          if (window.toGeoJSON) return resolve();
          const check = setInterval(()=>{ if (window.toGeoJSON){ clearInterval(check); resolve(); } }, 50);
          setTimeout(()=>{ clearInterval(check); resolve(); }, 1500);
        });
        if (!window.toGeoJSON) throw new Error('toGeoJSON library did not load');

        const res = await fetch(KML_URL + '?t=' + Date.now(), { cache:'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const text = await res.text();

        const kmlDoc = new DOMParser().parseFromString(text, 'text/xml');
        const gj = toGeoJSON.kml(kmlDoc);

        if (!gj.features || gj.features.length === 0) {
          alert('KML loaded but has 0 drawable features (add a Placemark/Line/Polygon).');
          return;
        }

        const layer = L.geoJSON(gj, {
          pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
            radius:5, color:'#1565c0', fillColor:'#42a5f5', fillOpacity:0.9, weight:1
          }).bindPopup(f.properties?.name || 'Placemark'),
          style:()=>({ color:'#2e7d32', weight:2, fillColor:'#66bb6a', fillOpacity:0.4 })
        }).addTo(map);

        try { map.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch {}
      } catch (e) {
        console.error(e);
        alert('Could not fetch KML: ' + e.message + '\nURL: ' + KML_URL);
      }
    })();
  </script>
</body>
</html>
